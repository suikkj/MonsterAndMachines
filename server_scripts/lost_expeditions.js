// Priority: 0
// Lost Expeditions - Lore books from the 12 lost expedition groups

var EXPEDITION_LORE = {
    group1: {
        title: 'Grupo de Expedição',
        author: 'Sunny Dantas',
        pages: [
            'Dia 1\n\nFinalmente saímos do Refúgio Cigarra após 2.740 anos. A superfície é... como foi descrita pelos cientistas da T.U.R.. Ainda sim, é difícil acreditar que isso é o que restou. Em livros e fotografias, eu e o Nimbus sempre víamos como o mundo era',
            'antigamente. Os reinos, as árvores. Como que construções tão grandiosas se tornaram... apenas ruínas?\n\nCascas vazias de algo que já foi cheio de vida.',
            'Dia 2\n\nA dificuldade avisada antes de sair, antes poderia apenas parecer exagero, mas agora entendo. Dormir na superfície.. Até se manter nela parece uma tarefa difícil. Diria impoossível, dada a missão que nos foi dada. Não consigo ver a esperança para',
            'essa terra. Não agora. Uma terra infértil, onde toda a vida foi sugada. É difícil entender se essa terra quer me sugar junto com o resto da vida ao redor dela.',
            'Dia 4\n\nSaímos para explorar na superfície. Realmente, as dicas que a T.U.R. deu eram úteis. Ouro é realmente a chave para algumas coisas, mesmo que temporariamente. Encontramos o que parece ser ruínas de uma antiga vila. Me ',
            'pergunto o que permitiu algumas construções de manterem mais do que outras. Foi sorte? Foi um outro povo que vivia aqui? Ou houve algum ato nisso? Independente, vamos ten',
            'Tem alguém aqui.\n\n\n\n\n'
        ]
    },
    group2: {
        title: 'Relatório do Grupo 2',
        author: 'Dr. Lynnus',
        pages: [
            'Início da Expedição\n26/09/5912\n\n\n\n\n\n\n\n\n\n\nPropriedade Privada\nda T.U.R.',
            'Início da Expedição sob a superfície remanescente de Asttär. Durante as investigações, percebi índices de algumas ruínas e marcas que levam a cer que a loocalização do Refúgio Coruja se localiza a poucos quilômetros da capital. É possível analisar facilmente como o',
            'vírus VALID-71 (Vazio) tem sua preferência e foco por aquilo que é vivo e possui consciência. Acredito eu que moradores do lixão estariam a salvo nessas terras desoladas.\n\nBrincadeiras à parte, é, no mínimo curioso ver até onde esse',
            'vírus pode ir. Com as teorias sobre o possível envolvimento humano na criação do mesmo me trás um medo e ao mesmo tempo um fascínio vindos da mesma pergunta. Por que?.',
            'Foram coletados amostras do VALID-71 de áreas diferentes. Das áreas completamente consumidas até as que mantiveram de pé, mesmo que em ruínas. Eviaremos isso ao Refúgio Coruja para que enviem a cientista do Refúgio Cobra. Talvez as amostras possam ajudar em',
            'suas pesquisas.',
            'Um companheiro de expedição, Vector, veio me comunicar que, durante suas explorações sobr ediferentes ruínas, ele parece ter encontrado Alguém. Suas vestes e aparências não pareciam ter vindo de um Refúgio. Pelo menos não os Refúgios que conhecemos. ',
            'Irei imediatamente com ele ao local de encontro. Talvez possamos ter respostas.',
            'Agora consigo entender. Parece... que tudo foi algum tipo de piada cósmica sobre nós, não é? Dançamos a sua dança como você queria, universo. Tudo bem... Se é isso que você quer, não só para mim, mas para todos que ousaram pisar na sterras que você tomou com suas',
            'rédeas de aço, não irei intervir. Apenas deixo um aviso, caso hajam leitores que tenham sido burros o suficiente de pisar para fora do Refúgio por livre e espontânea voltade:\n\n',
            'Independente do que você escutar, não confie Nele. Você não vai conseguir enganar Ele. Muito menos arrancar algo Dele. Independente do que ele disser, não escute Ele.'
        ]
    },
    group3: {
        title: 'Galera Expedicionária 3',
        author: 'Carlito',
        pages: [
            'Ja que o pessoal do Refugio vai ler essas anotacoes, queria enfatizar A MISERIA DE SUPRIMENTO. VTNC T.U.R. EMPRESA DE MERDA.'
        ]
    },
    group4: {
        title: 'Piedade',
        author: 'Desconhecido',
        pages: [
            'É tudo que eu peço a quem estiver lendo isso. Piedade.\n\nMinha alma... ela foi corrompida pelo vazio capaz de preencher até o maior vão. O vazio está em mim. E se você está aqui, ovazio está em você. Ele te consumirá, lentamente, pouco a pouco.',
            'Suas palavras não serão apenas suas. Suas vontades não serão as suas vontades. Você não será mais você.\n\nA resposta para o vazio está lá. Além desses portões. Além do limite que nos foi posto. Além do mundo que nos foi criado.',
            'Porém, a salvação do vazio irá fazer você se perder de si mesmo.\n\nHá um mito no mundo. Um mito que se prova não mais apenas um mito depois do que eu vi, li, ouvi, senti.\n\nA Perdição. Ela... ela é a chave.',
            'A chave para se manter é se perder de si mesmo. Uma mente incapaz de pensar. Uma alma incapaz de sentir.',
            'O que você escolhe? Não ser você, ou se perder de si mesmo?\n\n\nSe deseja a salvação, perante os riscos da perdição, abra os portões.'
        ]
    },
    group5: {
        title: 'Análise do Exterior',
        author: 'Jericó',
        pages: [
            '\n\n\n\n\n\n  Análise do Exterior\n        Jericó',
            'Análise da Expedição ao Exterior.\n\nMembros:\n- Sunny Dantas\n- Oribela Narciso\n- Jericó\n- Dottir Canvas\n- Kevin Carballo\n\n\n\nRefúgio Camaleão.',
            'De primeira, é inegável o poder do VALID-71. A sua capacidade de consumo é inimaginável. A tentativa de consumo as botas de ouro é persistente, porém o vírus não sobe mais do que até meu calcanhar antes de ser repelido.',
            'Os objetivos que foram passados para nós... Um tanto quanto estranhos. Caçar criaturas, evoluir nossa magia. Qual a razão de irmos contra tantas criaturas assim? O que isso beneficia a eles? Essas dúvidas me consomem sempre que eu encaro um novo objetivo.',
            'Dia 5\n\nA busca por um lugar para ficar é no mínimo cansativa. Montamos bases temporárias suspensas no ar mas nenhuma delas parece eficaz. E uma voz sempre me diz como é uma má ideia permanecer ali. Parece que quanto mais expostos no ar a',
            'a gente ficar, maior é nossa Exposição ao VALID-71. O ideal poderia ser a gente viver abaixo da terra, porém qualquer uso de máquinas abaixo da terra eventualmente trará o Companheiro, seja lá o que aquilo seja.',
            'Estamos começando a ficar sem ideias. Se o chão consome, o ar nos expõe a abaixo da terra chama criaturas? Qual outra opção teríamos? Até poderíamos usar uma máquina para criar uma dimensão de bolso temporária, mas com certeza isso chamaria as criaturas se ficássemos lá por',
            'muito tempo.\n\nSei que existem outras dimensões por aí. Talvez tentar viajar a alguma delas seja uma boa ideia, seja lá como faça essa viagem interdimensional.\n\nPensar aqui fora parece uma corrida contra o tempo.',
            'Dia 12\n\nSunny Dantas e Oribela Narciso saíram a 2 dias e ainda não voltaram. Eles buscavam analisar as ruínas dos lugares menos consumidos pelo vírus em busca de entender o que torna eles menos consumíveis e como podemos usar isso em',
            'prol de buscar um novo lugar para morar.\n\nSinceramente, apenas espero que eles não estejam flertando um com o outro enquanto matam a gente de preocupação.',
            'Dia 23\n\nApenas sobrou eu o Carballo agora. Os corpos deles... Os corpos deles estavam... Ai caralho.\n\nA gente vai ser o próximo? A gente tentou conversar, mas Ele não escuta. E agora. As estacas... Eu não quero fazer',
            'parte delas. Eu não quero morrer daquela forma. Eu não',
            'Para Lyrian, Tiberius e até você, Wallace,\n\n\nCaso chegue a vez de vocês irem para o Exterior (O que é óbvio que irá por conta do que fazemos), não tentem dialogar com Ele. Ele não parece alguém capaz de',
            'compreender o que dizemos. Todas as conversas que tivemos, Ele dizia poucas palavras, como se não tivesse muito vocabulário.\n\nEle é agressivo, impulsivo e pelo jeito um pouco ritualístico. Fiquem longe dele, não importa o quão tentador seja.',
            'Tenham coragem cósmica. Não sejam o Pietro da história (Desculpa a ofensa).\n\nEssa será minha última mensagem para vocês. Saibam que eu preferi ir ao mar de flores com honra do que cair no mar de espinhos.',
            'Obrigado Lyrian, Tiberius e Wallace por terem sido meus irmãos.\n\n\n\nCom a espada apontada para o segundo sol,\n\n\nJérico.'
        ]
    },

}

// Helper function to create a random lore book item
function createRandomLoreBook() {
    var keys = Object.keys(EXPEDITION_LORE)
    var key = keys[Math.floor(Math.random() * keys.length)]
    var lore = EXPEDITION_LORE[key]

    try {
        var pages = []
        for (var i = 0; i < lore.pages.length; i++) {
            var t = String(lore.pages[i])
            t = t.replace(/\\/g, '')
            t = t.replace(/"/g, '')
            t = t.replace(/'/g, '')
            pages.push("'{\"text\":\"" + t + "\"}'")
        }

        var title = lore.title.replace(/["'\\]/g, '')
        var author = lore.author.replace(/["'\\]/g, '')

        var snbt = 'minecraft:written_book[written_book_content={pages:[' + pages.join(',') + '],title:"' + title + '",author:"' + author + '",resolved:1b}]'

        return Item.of(snbt)
    } catch (e) {
        console.error('[Lost Expeditions] Error creating lore book: ' + e)
        return Item.of('minecraft:book')
    }
}

// Add books to loot tables
LootJS.modifiers(function (event) {
    console.info('[Lost Expeditions] Registering loot tables...')

    var tables = [
        /.*chests\/village.*/,
        /.*chests\/simple_dungeon.*/,
        /.*chests\/abandoned_mineshaft.*/,
        /.*chests\/stronghold.*/,
        /.*chests\/desert_pyramid.*/,
        /.*yung.*/,
        /.*dungeon.*/,
        /.*ruin.*/,
        'minecraft:blocks/barrel'
    ]

    // Individual rarity per book group
    // group1 = 1%, group2 = 0.5%, group3 = 1%, group4 = 0.5%, group5 = 0.12%
    var bookRarities = {
        group1: 0.01,   // 1%
        group2: 0.005,  // 0.5%
        group3: 0.01,   // 1%
        group4: 0.005,  // 0.5%
        group5: 0.0012  // 0.12%
    }

    // Add each book with its own chance
    var keys = Object.keys(EXPEDITION_LORE)
    for (var i = 0; i < keys.length; i++) {
        var key = keys[i]
        var rarity = bookRarities[key] || 0.01 // default 1% if not specified
        var book = createBookFromLore(EXPEDITION_LORE[key])

        event.addTableModifier(tables)
            .randomChance(rarity)
            .addLoot(book)

        console.info('[Lost Expeditions] ' + key + ' -> ' + (rarity * 100) + '% chance')
    }

    // Ancient cities - 5x higher chance for all books
    for (var j = 0; j < keys.length; j++) {
        var keyAncient = keys[j]
        var rarityAncient = (bookRarities[keyAncient] || 0.01) * 5 // 5x multiplier
        var bookAncient = createBookFromLore(EXPEDITION_LORE[keyAncient])

        event.addTableModifier(/.*ancient_city.*/)
            .randomChance(rarityAncient)
            .addLoot(bookAncient)
    }

    console.info('[Lost Expeditions] Registered ' + keys.length + ' lore books with individual rarities')
})

// Helper to create book from specific lore entry
function createBookFromLore(lore) {
    try {
        var pages = []
        for (var i = 0; i < lore.pages.length; i++) {
            var t = String(lore.pages[i])
            t = t.replace(/\\/g, '')
            t = t.replace(/"/g, '')
            t = t.replace(/'/g, '')
            pages.push("'{\"text\":\"" + t + "\"}'")
        }
        var title = lore.title.replace(/["'\\]/g, '')
        var author = lore.author.replace(/["'\\]/g, '')
        var snbt = 'minecraft:written_book[written_book_content={pages:[' + pages.join(',') + '],title:"' + title + '",author:"' + author + '",resolved:1b}]'
        return Item.of(snbt)
    } catch (e) {
        return Item.of('minecraft:book')
    }
}

// Test command
ServerEvents.commandRegistry(function (event) {
    var Commands = event.commands
    var StringArgumentType = Java.loadClass('com.mojang.brigadier.arguments.StringArgumentType')

    event.register(
        Commands.literal('testlorebook')
            .requires(function (src) { return src.hasPermission(2) })
            .executes(function (ctx) {
                var player = ctx.getSource().getPlayer()
                if (!player) return 0
                var keys = Object.keys(EXPEDITION_LORE)
                var key = keys[Math.floor(Math.random() * keys.length)]
                giveWrittenBook(player, EXPEDITION_LORE[key])
                return 1
            })
            .then(Commands.argument('group', StringArgumentType.word())
                .executes(function (ctx) {
                    var player = ctx.getSource().getPlayer()
                    var key = StringArgumentType.getString(ctx, 'group')
                    if (!player) return 0
                    if (!EXPEDITION_LORE[key]) {
                        player.tell(Text.of('Grupo nao encontrado: group1-group12'))
                        return 0
                    }
                    giveWrittenBook(player, EXPEDITION_LORE[key])
                    return 1
                })
            )
    )
    console.info('[Lost Expeditions] Command registered')
})

// Give written book - 1.21.1 format
function giveWrittenBook(player, lore) {
    try {
        // Build pages - REMOVE all quotes and backslashes (escaping breaks SNBT)
        var pages = []
        for (var i = 0; i < lore.pages.length; i++) {
            var t = String(lore.pages[i])
            // Remove ALL problematic characters - don't try to escape
            t = t.replace(/\\/g, '')
            t = t.replace(/"/g, '')
            t = t.replace(/'/g, '')
            pages.push("'{\"text\":\"" + t + "\"}'")
        }

        // Also clean title and author
        var title = lore.title.replace(/["'\\]/g, '')
        var author = lore.author.replace(/["'\\]/g, '')

        var snbt = 'minecraft:written_book[written_book_content={pages:[' + pages.join(',') + '],title:"' + title + '",author:"' + author + '",resolved:1b}]'

        console.info('[Lost Expeditions] Creating: ' + title)

        var book = Item.of(snbt)

        if (book && !book.isEmpty()) {
            player.give(book)
            player.tell(Text.of('Recebeu: ' + lore.title))
        } else {
            player.give(Item.of('minecraft:book'))
            player.tell(Text.of('Livro: ' + lore.title))
        }
    } catch (e) {
        console.error('[Lost Expeditions] Error: ' + e)
        player.give(Item.of('minecraft:writable_book'))
    }
}

console.info('[Lost Expeditions] Loaded')
